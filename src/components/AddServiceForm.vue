<template>
  <section id="add-service-form" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Agregar Nuevo Servicio</h2>
        <button class="close-btn" @click="closeForm">&times;</button>
      </div>
      <form @submit.prevent="submitService">
        <div class="form-group">
          <label for="service-name">Nombre del servicio:</label>
          <input type="text" id="service-name" v-model="serviceName" required placeholder="Ej: Reparaci√≥n de electrodom√©sticos">
        </div>
        <div class="form-group">
          <label for="user-email">Email de contacto:</label>
          <input type="email" id="user-email" v-model="userEmail" required placeholder="ejemplo@servicio.com">
        </div>
        <div class="form-group">
          <label for="service-address">Direcci√≥n del servicio:</label>
          <div class="address-input-container">
            <input type="text" id="service-address" v-model="serviceAddress" required placeholder="Ingresa la direcci√≥n...">
            <button type="button" class="change-location-btn" @click="changeLocation">üìç Cambiar ubicaci√≥n</button>
          </div>
        </div>
        <div class="form-group">
          <label>Categor√≠a del servicio:</label>
          <select id="service-category" v-model="serviceCategory" required>
            <option value="">Selecciona una categor√≠a</option>
            <option value="Dise√±o Gr√°fico">Dise√±o Gr√°fico</option>
            <option value="Carpinter√≠a">Carpinter√≠a</option>
            <option value="Electricista">Electricista</option>
            <option value="Fontaner√≠a">Fontaner√≠a</option>
            <option value="Clases particulares">Clases particulares</option>
            <option value="Otros">Otros</option>
          </select>
        </div>
        <button type="submit" class="submit-btn">Publicar Servicio</button>
      </form>
    </div>
  </section>
</template>

<script>
export default {
  name: 'AddServiceForm',
  props: {
    selectedLocation: {
      type: Object,
      required: false,
      default: null,
    },
  },
  data() {
    return {
      serviceName: '',
      userEmail: 'test@example.com', // Email por defecto
      serviceAddress: '',
      serviceCategory: '',
      skills: ['Dise√±o Gr√°fico', 'Carpinter√≠a', 'Electricista', 'Fontaner√≠a', 'Clases particulares', 'Otros'],
    };
  },
  watch: {
    // Observar cambios en selectedLocation para actualizar la direcci√≥n
    selectedLocation: {
      immediate: true,
      async handler(newLocation) {
        if (newLocation) {
          this.serviceAddress = await this.getStreetAddress(newLocation.lat, newLocation.lng);
        }
      }
    }
  },
  methods: {
    async getStreetAddress(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
        const response = await fetch(url);
        const data = await response.json();
        const address = data.address;
        const houseNumber = address.house_number || '';
        const road = address.road || '';
        const quarter = address.quarter || '';
        const town = address.town || address.city || address.village || '';
        return `${road}, ${quarter}, ${houseNumber}`.replace(/,(\s*,){1,}/g, ',').trim();
      } catch (error) {
        console.error('Error al obtener la direcci√≥n:', error);
        return 'Direcci√≥n no disponible';
      }
    },
    closeForm() {
      this.$emit('closeForm');
    },
    changeLocation() {
      this.$emit('changeLocation');
    },
    submitService() {
      if (!this.selectedLocation) {
        alert('Error: No se ha seleccionado ubicaci√≥n');
        return;
      }

      const newService = {
        id: Date.now(),
        serviceName: this.serviceName,
        email: this.userEmail,
        address: this.serviceAddress,
        category: this.serviceCategory,
        location: this.selectedLocation,
      };

      this.$emit('serviceAdded', newService);
      this.$emit('closeForm'); // Cerrar el modal despu√©s de agregar el servicio

      // Reset form fields
      this.serviceName = '';
      this.userEmail = '';
      this.serviceAddress = '';
      this.serviceCategory = '';

      alert('¬°Servicio publicado con √©xito!');
    },
  },
};
</script>

<style scoped>
/* Agrega aqu√≠ los estilos espec√≠ficos para el componente AddServiceForm */
</style>
